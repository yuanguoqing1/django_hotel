<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hotel Manager</title>
  <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { font-family: 'Inter', sans-serif; background: #f6f7fb; color: #1f2937; }
    body { margin: 0; padding: 24px; }
    h1 { margin-top: 0; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    label { display: block; margin-top: 8px; font-size: 0.9rem; color: #4b5563; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; }
    button { background: #2563eb; color: white; border: none; border-radius: 10px; padding: 10px 16px; font-weight: 600; cursor: pointer; margin-top: 12px; }
    button.secondary { background: #e5e7eb; color: #111827; }
    .list { margin: 0; padding: 0; list-style: none; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 0.8rem; }
    .pill.available { background: #dcfce7; color: #166534; }
    .pill.occupied { background: #fee2e2; color: #991b1b; }
    .pill.maintenance { background: #fef9c3; color: #92400e; }
    .pill.checked_in { background: #dbeafe; color: #1d4ed8; }
    .pill.completed { background: #ecfccb; color: #3f6212; }
    .pill.cancelled { background: #fef2f2; color: #991b1b; }
    .pill.active { background: #def7ec; color: #047857; }
    .pill.inactive { background: #fee2e2; color: #b91c1c; }
    .stack { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
    .small { font-size: 0.9rem; color: #6b7280; }
    .error { color: #b91c1c; }
  </style>
</head>
<body>
  <div id="app" class="stack">
    <header>
      <h1>酒店管理后台</h1>
      <p class="small">Django REST + Vue 轻量管理界面。确保后端运行在 <code>http://localhost:8000</code>。</p>
    </header>

    <div class="grid">
      <section class="card">
        <h2>客房列表</h2>
        <p class="small">查询或过滤可用状态。</p>
        <div class="stack">
          <label>筛选状态
            <select v-model="roomStatus" @change="loadRooms">
              <option value="">全部</option>
              <option value="available">可预订</option>
              <option value="occupied">在住</option>
              <option value="maintenance">维修</option>
            </select>
          </label>
          <p class="small error" v-if="roomsError">{{ roomsError }}</p>
        </div>
        <ul class="list stack">
          <li v-for="room in rooms" :key="room.id" class="card" style="padding:12px">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong>房间 {{ room.number }} · {{ room.room_type }}</strong>
              <span class="pill" :class="room.status">{{ room.status }}</span>
            </div>
            <p class="small">容量 {{ room.capacity }} · ¥{{ room.price }} / 晚</p>
            <p class="small" v-if="room.description">{{ room.description }}</p>
          </li>
        </ul>
      </section>

      <section class="card">
        <h2>新增住客</h2>
        <form @submit.prevent="createGuest" class="stack">
          <label>姓名<input v-model="guestForm.full_name" required /></label>
          <label>邮箱<input type="email" v-model="guestForm.email" required /></label>
          <label>电话<input v-model="guestForm.phone_number" /></label>
          <button type="submit">创建住客</button>
          <p class="small" v-if="guestMessage">{{ guestMessage }}</p>
        </form>

        <h2>预订房间</h2>
        <form @submit.prevent="createBooking" class="stack">
          <label>住客 (ID)<input v-model="bookingForm.guest" required /></label>
          <label>房间 ID<input v-model="bookingForm.room" required /></label>
          <label>入住日期<input type="date" v-model="bookingForm.check_in" required /></label>
          <label>退房日期<input type="date" v-model="bookingForm.check_out" required /></label>
          <label>备注<textarea v-model="bookingForm.notes"></textarea></label>
          <button type="submit">创建预订</button>
          <p class="small" v-if="bookingMessage">{{ bookingMessage }}</p>
        </form>
      </section>

      <section class="card">
        <h2>预订概览</h2>
        <p class="small">最新 10 条预订记录。</p>
        <p class="small error" v-if="bookingError">{{ bookingError }}</p>
        <ul class="list stack">
          <li v-for="booking in bookings" :key="booking.id" class="card" style="padding:12px">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong>房间 {{ booking.room_detail.number }} · {{ booking.guest_detail.full_name }}</strong>
              <span class="pill" :class="booking.status">{{ booking.status }}</span>
            </div>
            <p class="small">{{ booking.check_in }} → {{ booking.check_out }} · ¥{{ booking.total_price }}</p>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="secondary" @click="updateStatus(booking.id, 'check_in')">入住</button>
              <button class="secondary" @click="updateStatus(booking.id, 'complete')">完成</button>
              <button class="secondary" @click="updateStatus(booking.id, 'cancel')">取消</button>
            </div>
          </li>
        </ul>
      </section>

      <section class="card">
        <h2>服务管理</h2>
        <p class="small">查看启用服务，或快速新增与启用/停用。</p>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button class="secondary" @click="serviceFilterActive = !serviceFilterActive; loadServices();">
            {{ serviceFilterActive ? '查看全部服务' : '仅查看启用服务' }}
          </button>
          <span class="small" v-if="servicesLoading">加载中...</span>
          <span class="small error" v-if="servicesError">{{ servicesError }}</span>
        </div>

        <ul class="list stack" style="margin-top:8px;">
          <li v-for="service in services" :key="service.id" class="card" style="padding:12px">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <strong>{{ service.name }}</strong>
                <p class="small">¥{{ service.price }} · {{ service.description || '无描述' }}</p>
              </div>
              <div class="stack" style="align-items:flex-end; margin-top:0;">
                <span class="pill" :class="service.is_active ? 'active' : 'inactive'">
                  {{ service.is_active ? '已启用' : '已停用' }}
                </span>
                <button class="secondary" @click="toggleServiceStatus(service)">
                  {{ service.is_active ? '停用' : '启用' }}
                </button>
              </div>
            </div>
          </li>
          <li class="small" v-if="!servicesLoading && !servicesError && services.length === 0" style="padding:8px;">暂无服务</li>
        </ul>

        <h3 style="margin-top:16px;">新增服务</h3>
        <form @submit.prevent="submitService" class="stack">
          <label>名称<input v-model="serviceForm.name" required /></label>
          <label>价格<input type="number" min="0" step="0.01" v-model="serviceForm.price" required /></label>
          <label>描述<textarea v-model="serviceForm.description"></textarea></label>
          <label>状态
            <select v-model="serviceForm.is_active">
              <option :value="true">启用</option>
              <option :value="false">停用</option>
            </select>
          </label>
          <button type="submit">新增服务</button>
          <p class="small" v-if="serviceMessage">{{ serviceMessage }}</p>
        </form>
      </section>
    </div>
  </div>

  <script>
    const { createApp, ref, onMounted } = Vue;
    const apiBase = 'http://localhost:8000/api';

    const apiFetch = async (path, options = {}) => {
      const headers = options.headers ? { ...options.headers } : {};
      if (options.body && !headers['Content-Type']) {
        headers['Content-Type'] = 'application/json';
      }

      try {
        const res = await fetch(`${apiBase}${path}`, { ...options, headers });
        const contentType = res.headers.get('content-type') || '';
        const isJson = contentType.includes('application/json');
        const data = isJson ? await res.json() : await res.text();

        if (!res.ok) {
          const detail = typeof data === 'string' ? data : data?.detail || JSON.stringify(data);
          throw new Error(detail || '请求失败');
        }

        return { ok: true, data };
      } catch (error) {
        return { ok: false, error: error.message || '网络错误' };
      }
    };

    createApp({
      setup() {
        const rooms = ref([]);
        const bookings = ref([]);
        const services = ref([]);
        const roomStatus = ref('');
        const serviceFilterActive = ref(true);
        const guestMessage = ref('');
        const bookingMessage = ref('');
        const serviceMessage = ref('');
        const roomsError = ref('');
        const bookingError = ref('');
        const servicesError = ref('');
        const servicesLoading = ref(false);
        const guestForm = ref({ full_name: '', email: '', phone_number: '' });
        const bookingForm = ref({ room: '', guest: '', check_in: '', check_out: '', notes: '' });
        const serviceForm = ref({ name: '', price: '', description: '', is_active: true });

        const loadRooms = async () => {
          roomsError.value = '';
          const statusQuery = roomStatus.value ? `?status=${roomStatus.value}` : '';
          const result = await apiFetch(`/rooms/${statusQuery}`);
          if (result.ok) {
            rooms.value = result.data;
          } else {
            rooms.value = [];
            roomsError.value = result.error;
          }
        };

        const loadBookings = async () => {
          bookingError.value = '';
          const result = await apiFetch('/bookings/');
          if (result.ok) {
            bookings.value = result.data;
          } else {
            bookings.value = [];
            bookingError.value = result.error;
          }
        };

        const loadServices = async () => {
          servicesError.value = '';
          servicesLoading.value = true;
          const query = serviceFilterActive.value ? '?active=true' : '';
          const result = await apiFetch(`/services/${query}`);
          servicesLoading.value = false;
          if (result.ok) {
            services.value = result.data;
          } else {
            services.value = [];
            servicesError.value = result.error;
          }
        };

        const createGuest = async () => {
          guestMessage.value = '';
          const result = await apiFetch('/guests/', {
            method: 'POST',
            body: JSON.stringify(guestForm.value),
          });
          if (result.ok) {
            guestMessage.value = `创建成功，住客ID: ${result.data.id}`;
            guestForm.value = { full_name: '', email: '', phone_number: '' };
          } else {
            guestMessage.value = result.error;
          }
        };

        const createBooking = async () => {
          bookingMessage.value = '';
          const result = await apiFetch('/bookings/', {
            method: 'POST',
            body: JSON.stringify(bookingForm.value),
          });
          if (result.ok) {
            bookingMessage.value = '预订已创建！';
            bookingForm.value = { room: '', guest: '', check_in: '', check_out: '', notes: '' };
            loadBookings();
            loadRooms();
          } else {
            bookingMessage.value = result.error;
          }
        };

        const updateStatus = async (id, action) => {
          const result = await apiFetch(`/bookings/${id}/${action}/`, { method: 'POST' });
          if (result.ok) {
            loadBookings();
            loadRooms();
          } else {
            bookingMessage.value = result.error;
          }
        };

        const submitService = async () => {
          serviceMessage.value = '';
          const payload = { ...serviceForm.value, price: Number(serviceForm.value.price || 0) };
          const result = await apiFetch('/services/', {
            method: 'POST',
            body: JSON.stringify(payload),
          });
          if (result.ok) {
            serviceMessage.value = '服务已创建！';
            serviceForm.value = { name: '', price: '', description: '', is_active: true };
            loadServices();
          } else {
            serviceMessage.value = result.error;
          }
        };

        const toggleServiceStatus = async (service) => {
          serviceMessage.value = '';
          const result = await apiFetch(`/services/${service.id}/`, {
            method: 'PATCH',
            body: JSON.stringify({ is_active: !service.is_active }),
          });
          if (result.ok) {
            serviceMessage.value = `${service.is_active ? '已停用' : '已启用'} ${service.name}`;
            loadServices();
          } else {
            serviceMessage.value = result.error;
          }
        };

        onMounted(() => {
          loadRooms();
          loadBookings();
          loadServices();
        });

        return {
          rooms,
          bookings,
          services,
          roomStatus,
          serviceFilterActive,
          guestForm,
          bookingForm,
          serviceForm,
          guestMessage,
          bookingMessage,
          serviceMessage,
          roomsError,
          bookingError,
          servicesError,
          servicesLoading,
          loadRooms,
          createGuest,
          createBooking,
          updateStatus,
          submitService,
          toggleServiceStatus,
          loadServices,
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
