<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hotel Manager</title>
  <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { font-family: 'Inter', sans-serif; background: #f6f7fb; color: #0f172a; }
    body { margin: 0; }
    h1, h2 { margin: 0; }
    a { color: inherit; text-decoration: none; }
    header { background: white; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05); padding: 16px 24px; position: sticky; top: 0; z-index: 10; }
    .header-inner { display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: 0 auto; }
    .brand { display: flex; gap: 12px; align-items: center; }
    .brand-badge { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, #2563eb, #7c3aed); display: grid; place-items: center; color: white; font-weight: 700; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; display: grid; gap: 24px; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .layout { display: grid; gap: 16px; grid-template-columns: 2fr 1.3fr; align-items: start; }
    @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }
    .card { background: white; border-radius: 14px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); border: 1px solid #e2e8f0; }
    .section-head { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    .subtle { color: #6b7280; font-size: 0.95rem; margin: 0; }
    label { display: block; margin-top: 8px; font-size: 0.9rem; color: #475569; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 10px 12px; margin-top: 6px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 1rem; background: #f8fafc; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus, select:focus, textarea:focus { border-color: #2563eb; outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); background: white; }
    .btn { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border: none; border-radius: 12px; padding: 10px 16px; font-weight: 700; cursor: pointer; margin-top: 12px; display: inline-flex; align-items: center; gap: 6px; justify-content: center; }
    .btn.secondary { background: #e5e7eb; color: #111827; }
    .btn.ghost { background: transparent; color: #1d4ed8; border: 1px solid #dbeafe; }
    .list { margin: 0; padding: 0; list-style: none; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 0.8rem; }
    .pill.available { background: #dcfce7; color: #166534; }
    .pill.occupied { background: #fee2e2; color: #991b1b; }
    .pill.maintenance { background: #fef9c3; color: #92400e; }
    .pill.checked_in { background: #dbeafe; color: #1d4ed8; }
    .pill.completed { background: #ecfccb; color: #3f6212; }
    .pill.cancelled { background: #fef2f2; color: #991b1b; }
    .pill.total { background: #e0f2fe; color: #075985; }
    .stack { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
    .small { font-size: 0.95rem; color: #6b7280; margin: 0; }
    .muted { color: #94a3b8; }
    .inline { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .empty { padding: 12px; border: 1px dashed #e5e7eb; border-radius: 12px; text-align: center; color: #6b7280; background: #f8fafc; }
    .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-top: 8px; }
    .stat-card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; background: linear-gradient(135deg, #f8fafc, #eef2ff); }
    .stat-title { color: #475569; font-size: 0.9rem; margin-bottom: 4px; }
    .stat-value { font-size: 1.6rem; font-weight: 800; margin: 0; }
    .tag { display: inline-flex; align-items: center; gap: 6px; font-size: 0.85rem; padding: 6px 10px; background: #eef2ff; color: #4338ca; border-radius: 999px; }
    .hero { background: white; border-radius: 14px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); border: 1px solid #e2e8f0; }
    .separator { height: 1px; background: #e2e8f0; margin: 4px 0 8px; }
    .error { color: #b91c1c; }
    .success { color: #166534; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="header-inner">
        <div class="brand">
          <div class="brand-badge">H</div>
          <div>
            <div class="inline">
              <h1>酒店管理后台</h1>
              <span class="tag">Django REST · Vue 3</span>
            </div>
            <p class="subtle">轻量运营面板，当前使用前端模拟数据（无需真实后端即可体验）。</p>
          </div>
        </div>
        <div class="inline">
          <span class="pill total">实时数据</span>
        </div>
      </div>
    </header>

    <main class="container">
      <section class="hero" v-if="!currentUser">
        <div class="section-head">
          <div>
            <h2>登录后台</h2>
            <p class="small">默认账号：用户名 admin · 密码 admin123（启动时自动创建）。</p>
          </div>
        </div>
        <form @submit.prevent="performLogin" class="grid" style="align-items:end;">
          <div>
            <label>用户名<input v-model="authForm.username" required autocomplete="username" /></label>
          </div>
          <div>
            <label>密码<input type="password" v-model="authForm.password" required autocomplete="current-password" /></label>
          </div>
          <button class="btn" type="submit" :disabled="authLoading">
            <span v-if="authLoading">登录中...</span>
            <span v-else>登录</span>
          </button>
        </form>
        <p class="small error" v-if="authError">{{ authError }}</p>
      </section>

      <section class="hero" v-else>
        <div class="section-head">
          <div>
            <h2>房态概览</h2>
            <p class="small">快速了解当前房间状态与运营数据。</p>
          </div>
          <div class="inline">
            <label class="small" style="margin-top:0;">筛选状态</label>
            <select v-model="roomStatus" @change="loadRooms" style="width:160px;">
              <option value="">全部</option>
              <option value="available">可预订</option>
              <option value="occupied">在住</option>
              <option value="maintenance">维修</option>
            </select>
            <span class="pill total">已登录 {{ currentUser.username }}</span>
            <button class="btn ghost" @click="logout">退出</button>
          </div>
        </div>
        <div class="status-grid">
          <div class="stat-card">
            <p class="stat-title">全部房间</p>
            <p class="stat-value">{{ totalRooms }}</p>
          </div>
          <div class="stat-card">
            <p class="stat-title">可预订</p>
            <p class="stat-value">{{ statusCounts.available || 0 }}</p>
          </div>
          <div class="stat-card">
            <p class="stat-title">在住</p>
            <p class="stat-value">{{ statusCounts.occupied || 0 }}</p>
          </div>
          <div class="stat-card">
            <p class="stat-title">维修</p>
            <p class="stat-value">{{ statusCounts.maintenance || 0 }}</p>
          </div>
        </div>
      </section>

      <div class="layout" v-if="currentUser">
        <section class="card">
          <div class="section-head">
            <div>
              <h2>客房列表</h2>
              <p class="small">查询或过滤可用状态。</p>
            </div>
            <span class="pill total">{{ rooms.length }} 间</span>
          </div>
          <div class="stack">
            <div v-if="roomsLoading" class="empty">房间加载中...</div>
            <div v-else-if="roomsError" class="empty error">{{ roomsError }}</div>
            <div v-else-if="rooms.length === 0" class="empty">暂无房间数据。</div>
            <ul v-else class="list stack">
              <li v-for="room in rooms" :key="room.id" class="card" style="padding:12px">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
                  <div>
                    <strong>房间 {{ room.number }} · {{ room.room_type }}</strong>
                    <p class="small">容量 {{ room.capacity }} · ¥{{ room.price }} / 晚</p>
                  </div>
                  <span class="pill" :class="room.status">{{ room.status }}</span>
                </div>
                <p class="small" v-if="room.description">{{ room.description }}</p>
              </li>
            </ul>
          </div>
        </section>

        <section class="card">
          <h2>可用房搜索</h2>
          <p class="small">选择起止日期，快速查询可入住的房间。</p>
          <form @submit.prevent="searchAvailability" class="stack">
            <label>开始日期<input type="date" v-model="availabilityForm.start" required /></label>
            <label>结束日期<input type="date" v-model="availabilityForm.end" required /></label>
            <button class="btn" type="submit" :disabled="availabilityLoading">
              <span v-if="availabilityLoading">查询中...</span>
              <span v-else>搜索可用房</span>
            </button>
          </form>
          <div class="separator"></div>
          <div class="stack">
            <div v-if="availabilityLoading" class="empty">正在查询可用房...</div>
            <div v-else-if="availabilityError" class="empty error">{{ availabilityError }}</div>
            <div v-else-if="availabilityResults.length === 0" class="empty">暂无可用房结果。</div>
            <ul v-else class="list stack">
              <li v-for="room in availabilityResults" :key="room.id" class="card" style="padding:12px">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
                  <div>
                    <strong>房间 {{ room.number }} · {{ room.room_type }}</strong>
                    <p class="small">容量 {{ room.capacity }} · ¥{{ room.price }} / 晚</p>
                  </div>
                  <span class="pill available">可用</span>
                </div>
                <p class="small" v-if="room.description">{{ room.description }}</p>
              </li>
            </ul>
          </div>
        </section>
      </div>

      <div class="layout" v-if="currentUser">
        <section class="card">
          <div class="section-head">
            <div>
              <h2>新增住客</h2>
              <p class="small">创建住客档案后再进行预订。</p>
            </div>
          </div>
          <form @submit.prevent="createGuest" class="stack">
            <label>姓名<input v-model="guestForm.full_name" required /></label>
            <label>邮箱<input type="email" v-model="guestForm.email" required /></label>
            <label>电话<input v-model="guestForm.phone_number" /></label>
            <button class="btn" type="submit" :disabled="guestLoading">
              <span v-if="guestLoading">创建中...</span>
              <span v-else>创建住客</span>
            </button>
            <p class="small success" v-if="guestMessage && !guestError">{{ guestMessage }}</p>
            <p class="small error" v-if="guestError">{{ guestError }}</p>
          </form>

          <div class="separator"></div>
          <div class="section-head">
            <div>
              <h2>预订房间</h2>
              <p class="small">填写住客和房间 ID，创建新的预订。</p>
            </div>
          </div>
          <form @submit.prevent="createBooking" class="stack">
            <label>住客 (ID)<input v-model="bookingForm.guest" required /></label>
            <label>房间 ID<input v-model="bookingForm.room" required /></label>
            <label>入住日期<input type="date" v-model="bookingForm.check_in" required /></label>
            <label>退房日期<input type="date" v-model="bookingForm.check_out" required /></label>
            <label>备注<textarea v-model="bookingForm.notes"></textarea></label>
            <button class="btn" type="submit" :disabled="bookingLoading">
              <span v-if="bookingLoading">提交中...</span>
              <span v-else>创建预订</span>
            </button>
            <p class="small success" v-if="bookingMessage && !bookingError">{{ bookingMessage }}</p>
            <p class="small error" v-if="bookingError">{{ bookingError }}</p>
          </form>
        </section>

        <section class="card">
          <div class="section-head">
            <div>
              <h2>预订概览</h2>
              <p class="small">最新 10 条预订记录。</p>
            </div>
          </div>
          <div class="stack">
            <div v-if="bookingsLoading" class="empty">预订加载中...</div>
            <div v-else-if="bookingsError" class="empty error">{{ bookingsError }}</div>
            <div v-else-if="bookings.length === 0" class="empty">暂无预订记录。</div>
            <ul v-else class="list stack">
              <li v-for="booking in bookings" :key="booking.id" class="card" style="padding:12px">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
                  <div>
                    <strong>房间 {{ booking.room_detail.number }} · {{ booking.guest_detail.full_name }}</strong>
                    <p class="small">{{ booking.check_in }} → {{ booking.check_out }} · ¥{{ booking.total_price }}</p>
                  </div>
                  <span class="pill" :class="booking.status">{{ booking.status }}</span>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button class="btn secondary" @click="updateStatus(booking.id, 'check_in')">入住</button>
                  <button class="btn secondary" @click="updateStatus(booking.id, 'complete')">完成</button>
                  <button class="btn ghost" @click="updateStatus(booking.id, 'cancel')">取消</button>
                </div>
              </li>
            </ul>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const { createApp, ref, computed, onMounted } = Vue;
    const USE_MOCK_DATA = true;
    const apiBase = 'http://localhost:8000/api';

    const mockStore = {
      rooms: [
        { id: 1, number: '101', room_type: 'Single', capacity: 1, price: 79.99, status: 'occupied', description: 'Cozy single room with desk.' },
        { id: 2, number: '1012', room_type: '单人间', capacity: 1, price: 110.0, status: 'available', description: '' },
        { id: 3, number: '201', room_type: 'Double', capacity: 2, price: 109.99, status: 'maintenance', description: 'Spacious double room overlooking courtyard.' },
        { id: 4, number: '301', room_type: 'Suite', capacity: 4, price: 189.0, status: 'available', description: 'Corner suite with seating area.' },
      ],
      guests: [
        { id: 1, full_name: 'Alicia Chen', email: 'alicia@example.com', phone_number: '+1-555-1001' },
        { id: 2, full_name: 'Li Wei', email: 'liwei@example.com', phone_number: '+86-188-1001-0001' },
      ],
      bookings: [
        {
          id: 1,
          room: 1,
          guest: 1,
          check_in: dayjs().add(6, 'day').format('YYYY-MM-DD'),
          check_out: dayjs().add(15, 'day').format('YYYY-MM-DD'),
          status: 'checked_in',
          total_price: 719.91,
          notes: '欢迎入住',
        },
        {
          id: 2,
          room: 3,
          guest: 1,
          check_in: dayjs().add(0, 'day').format('YYYY-MM-DD'),
          check_out: dayjs().add(1, 'day').format('YYYY-MM-DD'),
          status: 'reserved',
          total_price: 15.0,
          notes: '',
        },
        {
          id: 3,
          room: 2,
          guest: 2,
          check_in: dayjs().add(1, 'day').format('YYYY-MM-DD'),
          check_out: dayjs().add(3, 'day').format('YYYY-MM-DD'),
          status: 'reserved',
          total_price: 189.98,
          notes: '延迟入住',
        },
      ],
      services: [
        { id: 1, name: 'Breakfast', description: 'Fresh continental breakfast', price: 12.0, is_active: true },
      ],
      nextIds: { room: 5, guest: 3, booking: 4 },
    };

    const apiFetch = async (path, options = {}) => {
      if (USE_MOCK_DATA) {
        return mockApi(path, options);
      }

      const headers = options.headers ? { ...options.headers } : {};
      const token = localStorage.getItem('token');
      if (token) {
        headers['Authorization'] = `Token ${token}`;
      }
      if (options.body && !headers['Content-Type']) {
        headers['Content-Type'] = 'application/json';
      }

      try {
        const res = await fetch(`${apiBase}${path}`, { ...options, headers });
        const contentType = res.headers.get('content-type') || '';
        const isJson = contentType.includes('application/json');
        const data = isJson ? await res.json() : await res.text();

        if (!res.ok) {
          const detail = typeof data === 'string' ? data : data?.detail || JSON.stringify(data);
          throw new Error(detail || '请求失败');
        }

        return { ok: true, data };
      } catch (error) {
        return { ok: false, error: error.message || '网络错误' };
      }
    };

    const mockApi = async (path, options = {}) => {
      await new Promise((resolve) => setTimeout(resolve, 200)); // simulate latency
      try {
        if (path === '/auth/login/' && options.method === 'POST') {
          const body = JSON.parse(options.body || '{}');
          if (body.username === 'admin' && body.password === 'admin123') {
            const data = { token: 'mock-token', user: { id: 1, username: 'admin', is_staff: true, is_superuser: true } };
            localStorage.setItem('token', data.token);
            return { ok: true, data };
          }
          throw new Error('用户名或密码错误');
        }

        if (path === '/auth/me/') {
          const token = localStorage.getItem('token');
          if (token === 'mock-token') {
            return { ok: true, data: { id: 1, username: 'admin', is_staff: true, is_superuser: true } };
          }
          throw new Error('未登录');
        }

        if (path === '/auth/logout/' && options.method === 'POST') {
          localStorage.removeItem('token');
          return { ok: true, data: {} };
        }

        if (path.startsWith('/rooms/available')) {
          const url = new URL(`http://localhost${path}`);
          const start = url.searchParams.get('start');
          const end = url.searchParams.get('end');
          if (!start || !end || dayjs(end).isSameOrBefore(start)) {
            throw new Error('日期范围无效');
          }
          const activeStatuses = ['reserved', 'checked_in'];
          const available = mockStore.rooms.filter((room) => {
            const overlap = mockStore.bookings.some((b) => {
              if (b.room !== room.id) return false;
              if (!activeStatuses.includes(b.status)) return false;
              return dayjs(b.check_in).isBefore(end) && dayjs(b.check_out).isAfter(start);
            });
            return !overlap && room.status !== 'maintenance';
          });
          return { ok: true, data: available };
        }

        if (path.startsWith('/rooms/')) {
          const statusQuery = path.split('?')[1];
          if (statusQuery) {
            const [, status] = statusQuery.split('=');
            return { ok: true, data: mockStore.rooms.filter((r) => r.status === status) };
          }
          return { ok: true, data: mockStore.rooms };
        }

        if (path === '/bookings/' && (!options.method || options.method === 'GET')) {
          const data = mockStore.bookings
            .map((b) => ({
              ...b,
              room_detail: mockStore.rooms.find((r) => r.id === b.room),
              guest_detail: mockStore.guests.find((g) => g.id === b.guest),
            }))
            .sort((a, b) => dayjs(b.check_in).valueOf() - dayjs(a.check_in).valueOf());
          return { ok: true, data };
        }

        if (path === '/bookings/' && options.method === 'POST') {
          const payload = JSON.parse(options.body || '{}');
          const room = mockStore.rooms.find((r) => r.id === Number(payload.room));
          const guest = mockStore.guests.find((g) => g.id === Number(payload.guest));
          if (!room || !guest) throw new Error('住客或房间不存在');
          const start = dayjs(payload.check_in);
          const end = dayjs(payload.check_out);
          if (!start.isValid() || !end.isValid() || !end.isAfter(start)) throw new Error('日期无效');
          const nights = end.diff(start, 'day');
          const newBooking = {
            id: mockStore.nextIds.booking++,
            room: room.id,
            guest: guest.id,
            check_in: payload.check_in,
            check_out: payload.check_out,
            status: 'reserved',
            total_price: Number((nights * room.price).toFixed(2)),
            notes: payload.notes || '',
          };
          mockStore.bookings.push(newBooking);
          return { ok: true, data: newBooking };
        }

        const bookingActionMatch = path.match(/^\\/bookings\\/(\\d+)\\/(cancel|check_in|complete)\\/$/);
        if (bookingActionMatch && options.method === 'POST') {
          const [, id, action] = bookingActionMatch;
          const booking = mockStore.bookings.find((b) => b.id === Number(id));
          if (!booking) throw new Error('预订不存在');
          if (action === 'cancel') {
            booking.status = 'cancelled';
            const room = mockStore.rooms.find((r) => r.id === booking.room);
            if (room && room.status === 'occupied') room.status = 'available';
          }
          if (action === 'check_in') {
            booking.status = 'checked_in';
            const room = mockStore.rooms.find((r) => r.id === booking.room);
            if (room) room.status = 'occupied';
          }
          if (action === 'complete') {
            booking.status = 'completed';
            const room = mockStore.rooms.find((r) => r.id === booking.room);
            if (room) room.status = 'available';
          }
          booking.updated_at = new Date().toISOString();
          return { ok: true, data: booking };
        }

        if (path === '/guests/' && options.method === 'POST') {
          const payload = JSON.parse(options.body || '{}');
          const emailExists = mockStore.guests.some((g) => g.email === payload.email);
          if (emailExists) throw new Error('邮箱已存在');
          const newGuest = {
            id: mockStore.nextIds.guest++,
            full_name: payload.full_name,
            email: payload.email,
            phone_number: payload.phone_number || '',
          };
          mockStore.guests.push(newGuest);
          return { ok: true, data: newGuest };
        }

        if (path === '/services/') {
          return { ok: true, data: mockStore.services };
        }

        throw new Error('未实现的模拟接口');
      } catch (error) {
        return { ok: false, error: error.message || '模拟接口异常' };
      }
    };

    createApp({
      setup() {
        const rooms = ref([]);
        const bookings = ref([]);
        const services = ref([]);
        const roomStatus = ref('');
        const bookingFilterStatus = ref('');
        const bookingSearch = ref('');
        const guestMessage = ref('');
        const guestError = ref('');
        const guestLoading = ref(false);
        const bookingMessage = ref('');
        const bookingError = ref('');
        const bookingLoading = ref(false);
        const roomsLoading = ref(false);
        const roomsError = ref('');
        const bookingsLoading = ref(false);
        const bookingsError = ref('');
        const availabilityForm = ref({ start: dayjs().format('YYYY-MM-DD'), end: dayjs().add(1, 'day').format('YYYY-MM-DD') });
        const availabilityResults = ref([]);
        const availabilityLoading = ref(false);
        const availabilityError = ref('');
        const guestForm = ref({ full_name: '', email: '', phone_number: '' });
        const bookingForm = ref({ room: '', guest: '', check_in: '', check_out: '', notes: '' });
        const authForm = ref({ username: 'admin', password: 'admin123' });
        const authError = ref('');
        const authLoading = ref(false);
        const currentUser = ref(null);
        const isGuestSubmitting = ref(false);
        const isBookingSubmitting = ref(false);
        const actionLoading = ref({});
        const serviceFilterActive = ref('');
        const serviceForm = ref({});
        const statusCounts = computed(() => rooms.value.reduce((acc, room) => {
          acc[room.status] = (acc[room.status] || 0) + 1;
          return acc;
        }, {}));
        const totalRooms = computed(() => rooms.value.length);

        const setActionLoading = (id, value) => {
          actionLoading.value = { ...actionLoading.value, [id]: value };
        };

        const loadRooms = async () => {
          roomsLoading.value = true;
          roomsError.value = '';
          const statusQuery = roomStatus.value ? `?status=${roomStatus.value}` : '';
          const { ok, data, error } = await apiFetch(`/rooms/${statusQuery}`);
          roomsLoading.value = false;
          if (ok) {
            rooms.value = data;
          } else {
            rooms.value = [];
            roomsError.value = error || '房间加载失败，请检查后端服务。';
          }
        };

        const loadBookings = async () => {
          bookingsLoading.value = true;
          bookingsError.value = '';
          const { ok, data, error } = await apiFetch('/bookings/');
          bookingsLoading.value = false;
          if (ok) {
            bookings.value = data;
          } else {
            bookings.value = [];
            bookingsError.value = error || '预订加载失败，请检查后端服务。';
          }
        };

        const createGuest = async () => {
          if (isGuestSubmitting.value) return;
          guestMessage.value = '';
          guestError.value = '';
          guestLoading.value = true;
          isGuestSubmitting.value = true;
          const { ok, data, error } = await apiFetch('/guests/', {
            method: 'POST',
            body: JSON.stringify(guestForm.value),
          });
          if (ok) {
            guestMessage.value = `创建成功，住客ID: ${data.id}`;
            guestForm.value = { full_name: '', email: '', phone_number: '' };
          } else {
            guestError.value = error || '创建失败，请检查输入或后端日志。';
          }
          guestLoading.value = false;
          isGuestSubmitting.value = false;
        };

        const createBooking = async () => {
          if (isBookingSubmitting.value) return;
          bookingMessage.value = '';
          bookingError.value = '';
          bookingLoading.value = true;
          isBookingSubmitting.value = true;
          const { ok, error } = await apiFetch('/bookings/', {
            method: 'POST',
            body: JSON.stringify(bookingForm.value),
          });
          if (ok) {
            bookingMessage.value = '预订已创建！';
            bookingForm.value = { room: '', guest: '', check_in: '', check_out: '', notes: '' };
            await loadBookings();
            await loadRooms();
          } else {
            bookingError.value = error || '预订创建失败，请检查输入。';
          }
          bookingLoading.value = false;
          isBookingSubmitting.value = false;
        };

        const updateStatus = async (id, action) => {
          setActionLoading(id, true);
          const { error } = await apiFetch(`/bookings/${id}/${action}/`, { method: 'POST' });
          if (error) {
            bookingMessage.value = `操作失败：${error}`;
          } else {
            bookingMessage.value = '状态已更新。';
            await loadBookings();
            await loadRooms();
          }
          setActionLoading(id, false);
        };

        const searchAvailability = async () => {
          availabilityLoading.value = true;
          availabilityError.value = '';
          availabilityResults.value = [];
          const params = new URLSearchParams({
            start: availabilityForm.value.start,
            end: availabilityForm.value.end,
          });
          const { ok, data, error } = await apiFetch(`/rooms/available?${params.toString()}`);
          availabilityLoading.value = false;
          if (ok) {
            availabilityResults.value = data;
          } else {
            availabilityError.value = error || '可用房查询失败，请检查后端服务。';
          }
        };

        const loadServices = async () => {
          const { ok, data } = await apiFetch('/services/');
          services.value = ok ? data : [];
        };

        const performLogin = async () => {
          authError.value = '';
          authLoading.value = true;
          const { ok, data, error } = await apiFetch('/auth/login/', {
            method: 'POST',
            body: JSON.stringify(authForm.value),
          });
          authLoading.value = false;
          if (!ok) {
            authError.value = error || '登录失败';
            return;
          }
          localStorage.setItem('token', data.token);
          currentUser.value = data.user;
          await bootstrapData();
        };

        const fetchMe = async () => {
          const { ok, data, error } = await apiFetch('/auth/me/');
          if (ok) {
            currentUser.value = data;
          } else if (error) {
            localStorage.removeItem('token');
            currentUser.value = null;
          }
        };

        const logout = async () => {
          await apiFetch('/auth/logout/', { method: 'POST' });
          localStorage.removeItem('token');
          currentUser.value = null;
          rooms.value = [];
          bookings.value = [];
        };

        const bootstrapData = async () => {
          await Promise.all([loadRooms(), loadBookings(), loadServices()]);
        };

        onMounted(async () => {
          await fetchMe();
          if (currentUser.value) {
            await bootstrapData();
          }
        });

        return {
          rooms,
          bookings,
          services,
          roomStatus,
          guestForm,
          bookingForm,
          authForm,
          authError,
          authLoading,
          currentUser,
          actionLoading,
          guestMessage,
          guestError,
          guestLoading,
          bookingMessage,
          bookingError,
          bookingLoading,
          roomsLoading,
          roomsError,
          bookingsLoading,
          bookingsError,
          availabilityForm,
          availabilityResults,
          availabilityLoading,
          availabilityError,
          statusCounts,
          totalRooms,
          loadRooms,
          createGuest,
          createBooking,
          updateStatus,
          searchAvailability,
          loadServices,
          performLogin,
          fetchMe,
          logout,
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
